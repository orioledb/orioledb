-- Test bridge index behavior when table is truncated.
CREATE EXTENSION orioledb;
CREATE TABLE brin_test_multi (a INT, b BIGINT) using orioledb WITH (fillfactor=10) ;
INSERT INTO brin_test_multi
SELECT i/5 + mod(911 * i + 483, 25),
       i/10 + mod(751 * i + 221, 41)
  FROM generate_series(1,1000) s(i);
SELECT COUNT(*) FROM brin_test_multi WHERE a < 37;
 count 
-------
   124
(1 row)

CREATE INDEX brin_test_multi_idx ON brin_test_multi USING brin (a int4_minmax_multi_ops) WITH (pages_per_range=5);
NOTICE:  index bridging is enabled for orioledb table 'brin_test_multi'
DETAIL:  index access method 'brin' is supported only via index bridging for OrioleDB table
SELECT orioledb_tbl_indices('brin_test_multi'::regclass, true);
                  orioledb_tbl_indices                  
--------------------------------------------------------
 Index ctid_primary                                    +
     Index type: primary, unique, ctid                 +
     Leaf tuple size: 4, non-leaf tuple size: 1        +
     Non-leaf tuple fields: ctid                       +
     Leaf tuple fields: ctid, index_bridging_ctid, a, b+
 Index index_bridge                                    +
     Index type: secondary                             +
     Leaf tuple size: 2, non-leaf tuple size: 1        +
     Non-leaf tuple fields: index_bridging_ctid        +
     Leaf tuple fields: index_bridging_ctid, ctid      +
 Index toast                                           +
     Index type: secondary                             +
     Leaf tuple size: 4, non-leaf tuple size: 3        +
     Non-leaf tuple fields: ctid, attnum, chunknum     +
     Leaf tuple fields: ctid, attnum, chunknum, data   +
 
(1 row)

\d+ brin_test_multi
                              Table "public.brin_test_multi"
 Column |  Type   | Collation | Nullable | Default | Storage | Stats target | Description 
--------+---------+-----------+----------+---------+---------+--------------+-------------
 a      | integer |           |          |         | plain   |              | 
 b      | bigint  |           |          |         | plain   |              | 
Indexes:
    "brin_test_multi_idx" brin (a int4_minmax_multi_ops) WITH (pages_per_range='5')
Options: fillfactor=10, index_bridging=true

TRUNCATE brin_test_multi;
SELECT orioledb_tbl_indices('brin_test_multi'::regclass, true);
                  orioledb_tbl_indices                  
--------------------------------------------------------
 Index ctid_primary                                    +
     Index type: primary, unique, ctid                 +
     Leaf tuple size: 4, non-leaf tuple size: 1        +
     Non-leaf tuple fields: ctid                       +
     Leaf tuple fields: ctid, index_bridging_ctid, a, b+
 Index index_bridge                                    +
     Index type: secondary                             +
     Leaf tuple size: 2, non-leaf tuple size: 1        +
     Non-leaf tuple fields: index_bridging_ctid        +
     Leaf tuple fields: index_bridging_ctid, ctid      +
 Index toast                                           +
     Index type: secondary                             +
     Leaf tuple size: 4, non-leaf tuple size: 3        +
     Non-leaf tuple fields: ctid, attnum, chunknum     +
     Leaf tuple fields: ctid, attnum, chunknum, data   +
 
(1 row)

\d+ brin_test_multi
                              Table "public.brin_test_multi"
 Column |  Type   | Collation | Nullable | Default | Storage | Stats target | Description 
--------+---------+-----------+----------+---------+---------+--------------+-------------
 a      | integer |           |          |         | plain   |              | 
 b      | bigint  |           |          |         | plain   |              | 
Indexes:
    "brin_test_multi_idx" brin (a int4_minmax_multi_ops) WITH (pages_per_range='5')
Options: fillfactor=10, index_bridging=true

INSERT INTO brin_test_multi
SELECT i/5 + mod(911 * i + 483, 25),
       i/10 + mod(751 * i + 221, 41)
  FROM generate_series(1,1000) s(i);
set enable_seqscan = off;
EXPLAIN SELECT COUNT(*) FROM brin_test_multi WHERE a < 37;
                                         QUERY PLAN                                          
---------------------------------------------------------------------------------------------
 Aggregate  (cost=244.38..244.39 rows=1 width=8)
   ->  Custom Scan (o_scan) on brin_test_multi  (cost=13.07..233.80 rows=4233 width=0)
         Bitmap heap scan
         Recheck Cond: (a < 37)
         ->  Bitmap Index Scan on brin_test_multi_idx  (cost=0.00..12.02 rows=12698 width=0)
               Index Cond: (a < 37)
(6 rows)

SELECT COUNT(*) FROM brin_test_multi WHERE a < 37;
 count 
-------
   124
(1 row)

DROP TABLE brin_test_multi;
DROP EXTENSION orioledb;
RESET enable_seqscan;
