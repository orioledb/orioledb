-- Uncompressed
CREATE EXTENSION orioledb;
-- Wrapper function, which converts result of SQL query to the text
CREATE OR REPLACE FUNCTION query_to_text_filtered(sql TEXT, out result text)
        RETURNS SETOF TEXT AS $$
        BEGIN
                FOR result IN EXECUTE sql LOOP
			IF result NOT LIKE '%COMMIT%' AND result NOT LIKE '%BEGIN%' THEN
				RETURN NEXT;
			END IF;
                END LOOP;
        END $$
LANGUAGE plpgsql;
-- generate pseudo-random string function in deterministic way
CREATE FUNCTION generate_string(seed integer, length integer) RETURNS text
	AS $$
		SELECT substr(string_agg(
						substr(encode(sha256(seed::text::bytea || '_' || i::text::bytea), 'hex'), 1, 21),
				''), 1, length)
		FROM generate_series(1, (length + 20) / 21) i; $$
LANGUAGE SQL;
CREATE TABLE o_logical(id integer PRIMARY KEY, v1 text, v2 text) using orioledb WITH (compress = -1, toast_compress = -1, primary_compress = -1);
SELECT slot_name FROM pg_create_logical_replication_slot('regression_slot', 'test_decoding', false, true);
    slot_name    
-----------------
 regression_slot
(1 row)

---- Insert
INSERT INTO o_logical VALUES ('1', '101', '102');
INSERT INTO o_logical VALUES ('2', '201', '202');
--SELECT * FROM o_logical;
---- Update TOAST->TOAST
UPDATE o_logical SET (v1, v2) = ('301', '302') WHERE id = 1;
UPDATE o_logical SET v2 = '402' WHERE id = 2;
--SELECT * FROM o_logical;
--- Update TOAST->Inline
UPDATE o_logical SET (v1, v2) = ('501', '502') WHERE id = 1;
--SELECT * FROM o_logical WHERE id = 1;
SELECT query_to_text_filtered($$ SELECT data from pg_logical_slot_get_changes('regression_slot', NULL, NULL); $$);
                                            query_to_text_filtered                                             
---------------------------------------------------------------------------------------------------------------
 table toast.o_logical: INSERT: id[integer]:1 v1[text]:'101' v2[text]:'102'
 table toast.o_logical: INSERT: id[integer]:2 v1[text]:'201' v2[text]:'202'
 table public.o_logical: UPDATE: old-key: id[integer]:1 new-tuple: id[integer]:1 v1[text]:'301' v2[text]:'302'
 table public.o_logical: UPDATE: old-key: id[integer]:2 new-tuple: id[integer]:2 v1[text]:'201' v2[text]:'402'
 table public.o_logical: UPDATE: old-key: id[integer]:1 new-tuple: id[integer]:1 v1[text]:'501' v2[text]:'502'
(5 rows)

SELECT pg_drop_replication_slot('regression_slot');
 pg_drop_replication_slot 
--------------------------
 
(1 row)

DROP TABLE o_logical;
