CREATE SCHEMA generated_test;
SET SESSION search_path = 'generated_test';
CREATE EXTENSION orioledb;
CREATE TABLE o_test_generated (
	a int,
	b int GENERATED ALWAYS AS (a * 2) STORED
) USING orioledb;
INSERT INTO o_test_generated VALUES (1), (2);
SELECT * FROM o_test_generated;
 a | b 
---+---
 1 | 2
 2 | 4
(2 rows)

CREATE TABLE o_test_generated_like (
	LIKE o_test_generated INCLUDING GENERATED
) USING orioledb;
INSERT INTO o_test_generated_like VALUES (5), (6);
SELECT * FROM o_test_generated_like;
 a | b  
---+----
 5 | 10
 6 | 12
(2 rows)

CREATE TABLE o_test_drop_expression (
    a int,
	b int GENERATED ALWAYS AS (a * 2) STORED
) USING orioledb;
INSERT INTO o_test_drop_expression VALUES (1);
INSERT INTO o_test_drop_expression VALUES (2);
SELECT * FROM o_test_drop_expression;
 a | b 
---+---
 1 | 2
 2 | 4
(2 rows)

ALTER TABLE o_test_drop_expression ALTER COLUMN a DROP EXPRESSION;
ERROR:  column "a" of relation "o_test_drop_expression" is not a stored generated column
ALTER TABLE o_test_drop_expression ALTER COLUMN b DROP EXPRESSION;
INSERT INTO o_test_drop_expression VALUES (3);
SELECT * FROM o_test_drop_expression;
 a | b 
---+---
 1 | 2
 2 | 4
 3 |  
(3 rows)

CREATE TABLE o_test_add_identity_exist (
    a SMALLINT GENERATED BY DEFAULT AS IDENTITY (START WITH 7 INCREMENT BY 5),
    b TEXT
) USING orioledb;
ALTER TABLE o_test_add_identity_exist
	ALTER COLUMN a ADD GENERATED ALWAYS AS IDENTITY;
ERROR:  column "a" of relation "o_test_add_identity_exist" is already an identity column
INSERT INTO o_test_add_identity_exist (b) VALUES ('a'), ('b'), ('c');
SELECT * FROM o_test_add_identity_exist;
 a  | b 
----+---
  7 | a
 12 | b
 17 | c
(3 rows)

CREATE TABLE o_test_add_identity (
    a SMALLINT,
    b TEXT
) USING orioledb;
ALTER TABLE o_test_add_identity
	ALTER COLUMN a SET NOT NULL,
	ALTER COLUMN a ADD GENERATED ALWAYS AS IDENTITY;
INSERT INTO o_test_add_identity (b) VALUES ('a'), ('b'), ('c');
SELECT * FROM o_test_add_identity;
 a | b 
---+---
 1 | a
 2 | b
 3 | c
(3 rows)

ALTER TABLE o_test_add_identity
	ALTER COLUMN a RESTART WITH 10;
INSERT INTO o_test_add_identity (b) VALUES ('A'), ('B'), ('C');
SELECT * FROM o_test_add_identity;
 a  | b 
----+---
  1 | a
  2 | b
  3 | c
 10 | A
 11 | B
 12 | C
(6 rows)

ALTER TABLE o_test_add_identity
	ALTER COLUMN a DROP IDENTITY,
	ALTER COLUMN a DROP NOT NULL;
INSERT INTO o_test_add_identity (b) VALUES ('X'), ('Y'), ('Z');
SELECT * FROM o_test_add_identity;
 a  | b 
----+---
  1 | a
  2 | b
  3 | c
 10 | A
 11 | B
 12 | C
    | X
    | Y
    | Z
(9 rows)

CREATE TABLE o_test_generated_null (
    val_1 text,
    val_2 int GENERATED ALWAYS AS (1 + COALESCE(val_3::text, '0')::int) STORED,
	val_3 int DEFAULT 5
) USING orioledb;
\d+ o_test_generated_null
                                                         Table "generated_test.o_test_generated_null"
 Column |  Type   | Collation | Nullable |                                  Default                                   | Storage  | Stats target | Description 
--------+---------+-----------+----------+----------------------------------------------------------------------------+----------+--------------+-------------
 val_1  | text    |           |          |                                                                            | extended |              | 
 val_2  | integer |           |          | generated always as (1 + COALESCE(val_3::text, '0'::text)::integer) stored | plain    |              | 
 val_3  | integer |           |          | 5                                                                          | plain    |              | 

INSERT INTO o_test_generated_null (val_1, val_3) VALUES (1, NULL);
INSERT INTO o_test_generated_null (val_1, val_3) VALUES (NULL, NULL);
SELECT orioledb_tbl_structure('o_test_generated_null'::regclass, 'nue');
                       orioledb_tbl_structure                        
---------------------------------------------------------------------
 Index ctid_primary contents                                        +
 Page 0: level = 0, maxKeyLen = 8, nVacatedBytes = 0                +
 state = free, datoid equal, relnode equal, ix_type = primary, dirty+
     Leftmost, Rightmost                                            +
   Chunk 0: offset = 0, location = 256, hikey location = 64         +
     Item 0: offset = 264, tuple = ('(0,1)', '1', '1', null)        +
     Item 1: offset = 312, tuple = ('(0,2)', null, '1', null)       +
                                                                    +
 Index toast: not loaded                                            +
 
(1 row)

SELECT * FROM o_test_generated_null;
 val_1 | val_2 | val_3 
-------+-------+-------
 1     |     1 |      
       |     1 |      
(2 rows)

CREATE TABLE o_test_tableoid (
  val_1 int PRIMARY KEY,
  val_2 bool GENERATED ALWAYS
    AS (tableoid = 'o_test_tableoid'::regclass) STORED
) USING orioledb;
INSERT INTO o_test_tableoid VALUES (1), (2);
ALTER TABLE o_test_tableoid ADD COLUMN
  val_3 regclass GENERATED ALWAYS AS (tableoid) STORED;
SELECT * FROM o_test_tableoid;
 val_1 | val_2 |      val_3      
-------+-------+-----------------
     1 | t     | o_test_tableoid
     2 | t     | o_test_tableoid
(2 rows)

CREATE TABLE o_test_generated_alter_type (
    val_1 int,
    val_3 int GENERATED ALWAYS AS (val_1 * 2) STORED
) USING orioledb;
INSERT INTO o_test_generated_alter_type (val_1) VALUES (1), (3);
SELECT * FROM o_test_generated_alter_type;
 val_1 | val_3 
-------+-------
     1 |     2
     3 |     6
(2 rows)

SELECT orioledb_tbl_structure('o_test_generated_alter_type'::regclass, 'nue');
                       orioledb_tbl_structure                        
---------------------------------------------------------------------
 Index ctid_primary contents                                        +
 Page 0: level = 0, maxKeyLen = 8, nVacatedBytes = 0                +
 state = free, datoid equal, relnode equal, ix_type = primary, dirty+
     Leftmost, Rightmost                                            +
   Chunk 0: offset = 0, location = 256, hikey location = 64         +
     Item 0: offset = 264, tuple = ('(0,1)', '1', '2')              +
     Item 1: offset = 296, tuple = ('(0,2)', '3', '6')              +
                                                                    +
 Index toast: not loaded                                            +
 
(1 row)

ALTER TABLE o_test_generated_alter_type ALTER COLUMN val_3 TYPE numeric;
SELECT * FROM o_test_generated_alter_type;
 val_1 | val_3 
-------+-------
     1 |     2
     3 |     6
(2 rows)

-- Test AT_SetExpression (ALTER TABLE ... ALTER COLUMN ... SET EXPRESSION)
-- Two generated columns altered in a single ALTER TABLE statement
CREATE TABLE o_test_set_expression (
	i int PRIMARY KEY,
	price numeric(10,2),
	quantity int,
	total numeric(10,2) GENERATED ALWAYS AS (price * quantity) STORED,
	discounted numeric(10,2) GENERATED ALWAYS AS (price * 0.9) STORED
) USING orioledb;
INSERT INTO o_test_set_expression (i, price, quantity) VALUES (1, 10.50, 5);
INSERT INTO o_test_set_expression (i, price, quantity) VALUES (2, 25.00, 3);
INSERT INTO o_test_set_expression (i, price, quantity) VALUES (3, 7.99, 10);
-- Verify initial generated column values
SELECT i, price, quantity, total, discounted FROM o_test_set_expression ORDER BY i;
 i | price | quantity | total | discounted 
---+-------+----------+-------+------------
 1 | 10.50 |        5 | 52.50 |       9.45
 2 | 25.00 |        3 | 75.00 |      22.50
 3 |  7.99 |       10 | 79.90 |       7.19
(3 rows)

-- Snapshot the table before changing the expressions
CREATE MATERIALIZED VIEW o_test_set_expr_mv USING orioledb AS
	SELECT * FROM o_test_set_expression ORDER BY i;
SELECT * FROM o_test_set_expr_mv ORDER BY i;
 i | price | quantity | total | discounted 
---+-------+----------+-------+------------
 1 | 10.50 |        5 | 52.50 |       9.45
 2 | 25.00 |        3 | 75.00 |      22.50
 3 |  7.99 |       10 | 79.90 |       7.19
(3 rows)

-- Check the initial generated column expressions in catalog
SELECT a.attname, pg_get_expr(d.adbin, d.adrelid) as generation_expr
FROM pg_attribute a
JOIN pg_attrdef d ON d.adrelid = a.attrelid AND d.adnum = a.attnum
WHERE a.attrelid = 'o_test_set_expression'::regclass
  AND a.attname IN ('total', 'discounted')
ORDER BY a.attnum;
  attname   |        generation_expr        
------------+-------------------------------
 total      | (price * (quantity)::numeric)
 discounted | (price * 0.9)
(2 rows)

-- Change both generated columns in a single ALTER TABLE
ALTER TABLE o_test_set_expression
  ALTER COLUMN total SET EXPRESSION AS (price * quantity * 1.1),
  ALTER COLUMN discounted SET EXPRESSION AS (price * 0.75);
ERROR:  syntax error at or near "EXPRESSION"
LINE 2:   ALTER COLUMN total SET EXPRESSION AS (price * quantity * 1...
                                 ^
-- Verify both expressions were updated in catalog
SELECT a.attname, pg_get_expr(d.adbin, d.adrelid) as generation_expr
FROM pg_attribute a
JOIN pg_attrdef d ON d.adrelid = a.attrelid AND d.adnum = a.attnum
WHERE a.attrelid = 'o_test_set_expression'::regclass
  AND a.attname IN ('total', 'discounted')
ORDER BY a.attnum;
  attname   |        generation_expr        
------------+-------------------------------
 total      | (price * (quantity)::numeric)
 discounted | (price * 0.9)
(2 rows)

-- Verify all existing values were recalculated with new expressions
SELECT i, price, quantity, total, discounted,
	(price * quantity * 1.1) as expected_total,
	(price * 0.75) as expected_discounted
FROM o_test_set_expression ORDER BY i;
 i | price | quantity | total | discounted | expected_total | expected_discounted 
---+-------+----------+-------+------------+----------------+---------------------
 1 | 10.50 |        5 | 52.50 |       9.45 |         57.750 |              7.8750
 2 | 25.00 |        3 | 75.00 |      22.50 |         82.500 |             18.7500
 3 |  7.99 |       10 | 79.90 |       7.19 |         87.890 |              5.9925
(3 rows)

-- Matview should still have the old snapshot
SELECT * FROM o_test_set_expr_mv ORDER BY i;
 i | price | quantity | total | discounted 
---+-------+----------+-------+------------
 1 | 10.50 |        5 | 52.50 |       9.45
 2 | 25.00 |        3 | 75.00 |      22.50
 3 |  7.99 |       10 | 79.90 |       7.19
(3 rows)

-- Refresh picks up the new expressions
REFRESH MATERIALIZED VIEW o_test_set_expr_mv;
SELECT * FROM o_test_set_expr_mv ORDER BY i;
 i | price | quantity | total | discounted 
---+-------+----------+-------+------------
 1 | 10.50 |        5 | 52.50 |       9.45
 2 | 25.00 |        3 | 75.00 |      22.50
 3 |  7.99 |       10 | 79.90 |       7.19
(3 rows)

-- Update and verify recalculation
UPDATE o_test_set_expression SET price = 15.00 WHERE i = 1;
SELECT i, price, quantity, total, discounted,
	(price * quantity * 1.1) as expected_total,
	(price * 0.75) as expected_discounted
FROM o_test_set_expression ORDER BY i;
 i | price | quantity | total | discounted | expected_total | expected_discounted 
---+-------+----------+-------+------------+----------------+---------------------
 1 | 15.00 |        5 | 75.00 |      13.50 |         82.500 |             11.2500
 2 | 25.00 |        3 | 75.00 |      22.50 |         82.500 |             18.7500
 3 |  7.99 |       10 | 79.90 |       7.19 |         87.890 |              5.9925
(3 rows)

-- Insert new row to verify new expressions are used for new data
INSERT INTO o_test_set_expression (i, price, quantity) VALUES (4, 20.00, 2);
SELECT i, price, quantity, total, discounted,
	(price * quantity * 1.1) as expected_total,
	(price * 0.75) as expected_discounted
FROM o_test_set_expression ORDER BY i;
 i | price | quantity | total | discounted | expected_total | expected_discounted 
---+-------+----------+-------+------------+----------------+---------------------
 1 | 15.00 |        5 | 75.00 |      13.50 |         82.500 |             11.2500
 2 | 25.00 |        3 | 75.00 |      22.50 |         82.500 |             18.7500
 3 |  7.99 |       10 | 79.90 |       7.19 |         87.890 |              5.9925
 4 | 20.00 |        2 | 40.00 |      18.00 |         44.000 |             15.0000
(4 rows)

DROP TABLE o_test_set_expression CASCADE;
NOTICE:  drop cascades to materialized view o_test_set_expr_mv
DROP EXTENSION orioledb CASCADE;
NOTICE:  drop cascades to 8 other objects
DETAIL:  drop cascades to table o_test_generated
drop cascades to table o_test_generated_like
drop cascades to table o_test_drop_expression
drop cascades to table o_test_add_identity_exist
drop cascades to table o_test_add_identity
drop cascades to table o_test_generated_null
drop cascades to table o_test_tableoid
drop cascades to table o_test_generated_alter_type
DROP SCHEMA generated_test CASCADE;
RESET search_path;
